<!DOCTYPE html>
<html lang="en">
<head>

    <title>PLARA Simulator</title>

    <style>
        body { font-family: sans-serif; padding: 1rem; }
        h1 { text-decoration: underline}
        summary { margin-top: 2rem; margin-bottom: 1rem; font-size: 1.5rem; font-weight: bold; }
        #result { width: 80%; min-height: 20px; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; white-space: pre-wrap; background-color: #eee; }
        button { margin: 10px; padding: 0.5rem 1rem; cursor: pointer; }
        input, select { padding: 8px; margin: 5px 0; font-size: 16px; }
        label {font-weight: bold; }
        option { font-size: 16px; }
    </style>
</head>
<body>
<h1>Braude Project 2025 - PLARA Simulator</h1>
<h4>Created by Shlomi Fridman and Shahar Berenson</h4>
<br>

<div class="connection-control">
    <label for="addressField">Server URL:</label>
    <input id="addressField" style="width: 400px" type="text" value="wss://braudeproject2025server.onrender.com/" placeholder="Enter WebSocket URL" readonly disabled />
    <br>
    <button id="toggleBtn">Switch to localhost</button>
    <button id="openViewerBtn">Open Viewer</button>
</div>

<label for="result">Result Log:</label>
<pre id="result">Result will appear here...</pre>

<details open>
    <summary>Actions</summary>
    <button id="resetBtn">Reset System Status</button>
    <button id="regressionBtn">Regression Test</button>
    <br>
    <button onclick="initBadges()">Init Badges</button>
    <label for="groupNumberSelect">Select Quiz Group:</label>
    <select id="groupNumberSelect">
        <option value="1">Group 1</option>
        <option value="2">Group 2</option>
        <option value="3">Group 3</option>
    </select>
    <button id="getQuizBtn">Get Quiz</button>
</details>

<details open>
    <summary>User Actions</summary>
    <button onclick="resetAllUserBadges()">Reset All User Badges</button>
    <button onclick="resetAllUserProgress()">Reset All User Progress</button>
    <br>
    <label for="usernameField">Username:</label>
    <input id="usernameField" type="text" placeholder="Enter username" />
    <label for="badgeSelect">Select Badge:</label>
    <select id="badgeSelect">
        <option value="">Loading badges...</option>
    </select>
    <button id="addBadgeBtn">Add User Badge</button>
    <br>
    <button id="getBadgesBtn">Get User Badges</button>
    <button id="resetUserBadgesBtn">Reset User Badges</button>
    <button id="getProgressBtn">Get User Progress</button>
    <button id="resetUserProgressBtn">Reset User Progress</button>
    <button id="getQuizzesBtn">Get User Quizzes</button>
    <br>
    <div style="border: 2px solid #aaa; border-radius: 10px; padding: 15px; background-color: #f9f9f9; width: fit-content;">
        <strong>Update Progress</strong><br>

        <label for="playDurationInput">Play Duration (min):</label>
        <input type="number" id="playDurationInput" value="0" style="width: 60px;" /><br>
        <label>Completed Quiz:</label>
        <label>Guides Completed:</label><br>
        <label><input type="checkbox" name="guideIds" value="1"> Guide 1</label><br>
        <label><input type="checkbox" name="guideIds" value="2"> Guide 2</label><br>
        <label><input type="checkbox" name="guideIds" value="3"> Guide 3</label><br>
        <label><input type="checkbox" name="guideIds" value="4"> Guide 4</label><br>

        <button id="updateProgressBtn">Update Progress</button>
    </div>
</details>

<!-- <details open>
    <summary>IMU Message</summary>
    <form id="imuForm">
        <label>
            Cart ID:
            <select name="cart_id" required>
                <option value="cart_1">cart_1</option>
                <option value="cart_2">cart_2</option>
                <option value="cart_3">cart_3</option>
                <option value="cart_4">cart_4</option>
                <option value="cart_5">cart_5</option>
            </select>
        </label>
        <label>
            Speed:
            <input type="number" step="0.1" name="speed" min="0" required style="width: 70px" value="0.2"/>
        </label>
        <button type="submit">Send</button>
    </form>
</details> -->

<details open>
    <summary>QR Message</summary>

    <form id="qrForm">
        <label>
            Station ID:
            <select name="station_id" required>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </label>
        <label>
            Current Cart ID:
            <select name="current_cart_id" required>
                <option value="cart_empty" selected>cart_empty</option>
                <option value="cart_1">cart_1</option>
                <option value="cart_2">cart_2</option>
                <option value="cart_3">cart_3</option>
                <option value="cart_4">cart_4</option>
                <option value="cart_5">cart_5</option>
            </select>
        </label>
        <label>
            Old Cart ID:
            <select name="old_cart_id" required>
                <option value="cart_empty" selected>cart_empty</option>
                <option value="cart_1">cart_1</option>
                <option value="cart_2">cart_2</option>
                <option value="cart_3">cart_3</option>
                <option value="cart_4">cart_4</option>
                <option value="cart_5">cart_5</option>
            </select>
        </label>
        <button type="submit">Send</button>
    </form>

</details>

<script>
    // Connect to your WebSocket server
    const REMOTE_URL = 'https://braudeproject2025server.onrender.com';
    const LOCAL_URL = 'http://localhost:5000';

    const resultDiv = document.getElementById('result');
    const regressionTestBtn = document.getElementById('regressionBtn');
    const openViewerBtn = document.getElementById('openViewerBtn');
    const toggleBtn = document.getElementById('toggleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const addressField = document.getElementById('addressField');
    //const imuForm = document.getElementById('imuForm');
    const qrForm = document.getElementById('qrForm');

    let currentUrl = REMOTE_URL;
    addressField.value = currentUrl;

    openViewerBtn.addEventListener('click', () => {
        const path = window.location.pathname.split('/');
        path.pop();
        const newPath = path.join('/') || '/';
        window.open(newPath, '_blank');
    })

    toggleBtn.addEventListener('click', () => {

        if (currentUrl === REMOTE_URL) {
            currentUrl = LOCAL_URL;
            toggleBtn.textContent = 'Switch to remote';
        } else {
            currentUrl = REMOTE_URL;
            toggleBtn.textContent = 'Switch to localhost';
        }
        addressField.value = currentUrl;
    });

    resetBtn.addEventListener('click', () => {
        if (!confirm("Are you sure you want to restart?"))
            return;
        fetch(`${currentUrl}/sim/reset`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                resultDiv.textContent = data;
            })
            .catch(error => {
                resultDiv.textContent = `Error: ${error}`;
            });
    });

    regressionTestBtn.addEventListener('click', () => {
        if (!confirm("Are you sure you want to start a regression test?"))
            return;
        fetch(`${currentUrl}/sim/regressionTest`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                resultDiv.textContent = data;
            })
            .catch(error => {
                resultDiv.textContent = `Error: ${error}`;
            });
    });

    /* imuForm.addEventListener('submit', (e) => {
        e.preventDefault(); // prevent page reload
        const formData = new FormData(e.target);
        const payload = {
            cart_id: formData.get('cart_id'),
            speed: parseFloat(formData.get('speed'))
        };

        resultDiv.textContent = 'Sending POST request...';
        fetch(`${currentUrl}/sim/imu`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.text();
            })
            .then(data => resultDiv.textContent = data)
            .catch(error => resultDiv.textContent = `Error: ${error}`);
    }); */

    qrForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const station_id = parseInt(formData.get('station_id'));
        console.log(formData.get('station_id'))
        console.log(formData.get('current_cart_id'))
        const payload = {
            station_id: station_id,
            current_cart_id: formData.get('current_cart_id'),
            old_cart_id: formData.get('old_cart_id')
        };
        resultDiv.textContent = 'Sending Station POST request...';
        fetch(`${currentUrl}/sim/qr`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.text();
            })
            .then(data => resultDiv.textContent = data)
            .catch(error => resultDiv.textContent = `Error: ${error}`);
    });

    const initBadges = () =>{
        fetch(`${currentUrl}/dev/initBadges`, {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                resultDiv.textContent = data;
            })
            .catch(error => {
                resultDiv.textContent = `Error: ${error}`;
            });
    }

    const resetAllUserBadges = () =>{
        fetch(`${currentUrl}/dev/resetAllUserBadges`, {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                resultDiv.textContent = data;
            })
            .catch(error => {
                resultDiv.textContent = `Error: ${error}`;
            });
    }

        const resetAllUserProgress = () =>{
        fetch(`${currentUrl}/dev/resetAllUserProgress`, {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                resultDiv.textContent = data;
            })
            .catch(error => {
                resultDiv.textContent = `Error: ${error}`;
            });
    }

    const getBadgesBtn = (username) => {
        fetch(`${currentUrl}/user/getUserBadges/${username}`, {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            resultDiv.textContent = JSON.stringify(data, null, 2);
        })
        .catch(error => {
            resultDiv.textContent = `Error: ${error}`;
        });
    }

    document.getElementById('getBadgesBtn').addEventListener('click', () => {
        const username = document.getElementById('usernameField').value.trim();
        if (!username) {
            resultDiv.textContent = "Please enter a username.";
            return;
        }
        getBadgesBtn(username);
    });

    // load badges
    const badgeSelect = document.getElementById('badgeSelect');
    const addBadgeBtn = document.getElementById('addBadgeBtn');

    const loadBadges = () => {
        fetch(`${currentUrl}/data/getBadges`)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                return res.json();
            })
            .then(badges => {
                badgeSelect.innerHTML = '';
                badges.forEach(badge => {
                    const option = document.createElement('option');
                    option.value = badge.badge_id;
                    option.textContent = `ID: ${badge.badge_id} | ${badge.title} (${badge.description})`;
                    badgeSelect.appendChild(option);
                });
            })
            .catch(err => {
                badgeSelect.innerHTML = '<option value="">Error loading badges</option>';
                console.error(err);
            });
    };

    loadBadges();

    addBadgeBtn.addEventListener('click', () => {
    const username = document.getElementById('usernameField').value.trim();
    const badge_id = badgeSelect.value;

    if (!username) {
        resultDiv.textContent = 'Please enter a username.';
        return;
    }
    if (!badge_id) {
        resultDiv.textContent = 'Please select a badge.';
        return;
    }

    // add badge to user
    fetch(`${currentUrl}/user/addBadge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, badge_id: parseInt(badge_id) })
        })
        .then(res => res.json())
        .then(data => {
            resultDiv.textContent = data.message;
        })
        .catch(err => {
            resultDiv.textContent = `Error: ${err}`;
        });
    });

    // reset badges to user
    const resetUserBadgesBtn = document.getElementById('resetUserBadgesBtn');

    resetUserBadgesBtn.addEventListener('click', () => {
        if (!confirm("Are you sure? It can not be undone"))
            return;
        const username = document.getElementById('usernameField').value.trim();

        if (!username) {
            resultDiv.textContent = "Please enter a username.";
            return;
        }

        fetch(`${currentUrl}/dev/resetUserBadges/${username}`, {
            method: 'POST'
        })
        .then(res => res.text())
        .then(data => {
            resultDiv.textContent = data;
        })
        .catch(err => {
            resultDiv.textContent = `Error: ${err}`;
        });
    });

    // reset progress
    const resetUserProgressBtn = document.getElementById('resetUserProgressBtn');

    resetUserProgressBtn.addEventListener('click', () => {
        if (!confirm("Are you sure? It can not be undone"))
            return;
        const username = document.getElementById('usernameField').value.trim();

        if (!username) {
            resultDiv.textContent = "Please enter a username.";
            return;
        }

        fetch(`${currentUrl}/dev/resetUserProgress/${username}`, {
            method: 'POST'
        })
        .then(res => res.text())
        .then(data => {
            resultDiv.textContent = data;
        })
        .catch(err => {
            resultDiv.textContent = `Error: ${err}`;
        });
    });

    // get Quizzes
    const getQuizzesBtn = document.getElementById('getQuizzesBtn');
    getQuizzesBtn.addEventListener('click', () => {
        const username = document.getElementById('usernameField').value.trim();

        if (!username) {
            resultDiv.textContent = "Please enter a username.";
            return;
        }

        fetch(`${currentUrl}/user/getUserQuizzes/${username}`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            resultDiv.textContent = JSON.stringify(data, null, 2);
        })
        .catch(error => {
            resultDiv.textContent = `Error: ${error}`;
        });
    });

    // get Progress
    const getProgressBtn = document.getElementById('getProgressBtn');
    getProgressBtn.addEventListener('click', () => {
        const username = document.getElementById('usernameField').value.trim();

        if (!username) {
            resultDiv.textContent = "Please enter a username.";
            return;
        }

        fetch(`${currentUrl}/user/getProgress/${username}`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            resultDiv.textContent = JSON.stringify(data, null, 2);
        })
        .catch(error => {
            resultDiv.textContent = `Error: ${error}`;
        });
    });

    // update Progress
    const updateProgressBtn = document.getElementById('updateProgressBtn');
    updateProgressBtn.addEventListener('click', () => {
        const username = document.getElementById('usernameField').value.trim();

        if (!username) {
            resultDiv.textContent = "Please enter a username.";
            return;
        }

        const playDurationMin = parseInt(document.getElementById('playDurationInput').value) || 0;

        const guidesRead = Array.from(
            document.querySelectorAll("input[name='guideIds']:checked")
        ).map(cb => Number(cb.value));

        fetch(`${currentUrl}/user/updateProgress`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, playDurationMin, guidesRead })
        })
        .then(response => response.json())
        .then(data => {
            resultDiv.textContent = JSON.stringify(data, null, 2);
        })
        .catch(error => {
            resultDiv.textContent = `Error: ${error}`;
        });
    });

    const getQuizBtn = document.getElementById('getQuizBtn');
    const groupNumberSelect = document.getElementById('groupNumberSelect');

    getQuizBtn.addEventListener('click', () => {
        const groupNumber = groupNumberSelect.value;

        resultDiv.textContent = "Fetching quiz...";

        fetch(`${currentUrl}/data/getQuiz/${groupNumber}`, {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            resultDiv.textContent = JSON.stringify(data, null, 2);
        })
        .catch(err => {
            resultDiv.textContent = `Error: ${err}`;
        });
    });
</script>
</body>
</html>
